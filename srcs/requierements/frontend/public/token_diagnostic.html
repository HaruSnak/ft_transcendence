<!DOCTYPE html>
<html>
<head>
    <title>Token Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button { margin: 5px; padding: 10px; }
        pre { background-color: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Token Diagnostic Tool</h1>
    
    <div class="section">
        <h3>Actions</h3>
        <button onclick="showCurrentToken()">Show Current Token</button>
        <button onclick="clearAllStorage()">Clear All Storage</button>
        <button onclick="freshLogin()">Fresh Login</button>
        <button onclick="testCurrentAuth()">Test Current Auth</button>
        <button onclick="showAllStorage()">Show All Storage</button>
    </div>
    
    <div id="output"></div>

    <script>
        function log(message, data = null, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            let content = `<strong>[${timestamp}] ${message}</strong>`;
            
            if (data) {
                content += `<br><pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>`;
            }
            
            div.innerHTML = content;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function showCurrentToken() {
            const token = localStorage.getItem('authToken');
            if (token) {
                log('Current authToken in localStorage', {
                    length: token.length,
                    first50: token.substring(0, 50) + '...',
                    last50: '...' + token.substring(token.length - 50),
                    fullToken: token
                }, 'info');
                
                // Essayer de d√©coder le JWT
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        log('Decoded JWT payload', payload, 'success');
                        
                        // V√©rifier l'expiration
                        const now = Math.floor(Date.now() / 1000);
                        if (payload.exp && payload.exp < now) {
                            log('‚ùå Token is EXPIRED', { 
                                expiredAt: new Date(payload.exp * 1000),
                                now: new Date()
                            }, 'error');
                        } else if (payload.exp) {
                            log('‚úÖ Token is still valid', {
                                expiresAt: new Date(payload.exp * 1000)
                            }, 'success');
                        }
                    }
                } catch (e) {
                    log('‚ùå Failed to decode JWT', e.message, 'error');
                }
            } else {
                log('‚ùå No authToken found in localStorage', null, 'error');
            }
        }

        function clearAllStorage() {
            // Clear localStorage
            const localStorageKeys = Object.keys(localStorage);
            localStorage.clear();
            
            // Clear sessionStorage
            const sessionStorageKeys = Object.keys(sessionStorage);
            sessionStorage.clear();
            
            log('‚úÖ Cleared all storage', {
                localStorage: localStorageKeys,
                sessionStorage: sessionStorageKeys
            }, 'success');
        }

        function showAllStorage() {
            const localStorage_ = {};
            const sessionStorage_ = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                localStorage_[key] = localStorage.getItem(key);
            }
            
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                sessionStorage_[key] = sessionStorage.getItem(key);
            }
            
            log('All Storage Contents', {
                localStorage: localStorage_,
                sessionStorage: sessionStorage_
            }, 'info');
        }

        async function freshLogin() {
            try {
                log('üîÑ Attempting fresh login...', null, 'info');
                
                const response = await fetch('http://localhost:3003/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'testuser',
                        password: 'testpass123'
                    })
                });
                
                const data = await response.json();
                log('Login response', { status: response.status, data }, response.ok ? 'success' : 'error');
                
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                    log('‚úÖ New token stored in localStorage', {
                        tokenLength: data.token.length,
                        first50: data.token.substring(0, 50) + '...'
                    }, 'success');
                }
            } catch (error) {
                log('‚ùå Login failed', error.message, 'error');
            }
        }

        async function testCurrentAuth() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    log('‚ùå No token to test', null, 'error');
                    return;
                }
                
                log('üîÑ Testing current token...', {
                    tokenLength: token.length,
                    first50: token.substring(0, 50) + '...'
                }, 'info');
                
                const response = await fetch('http://localhost:3003/api/user/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                log('Profile test result', { 
                    status: response.status, 
                    data 
                }, response.ok ? 'success' : 'error');
                
            } catch (error) {
                log('‚ùå Auth test failed', error.message, 'error');
            }
        }

        // Au chargement de la page, afficher l'√©tat actuel
        window.onload = function() {
            log('üöÄ Token Diagnostic Tool loaded', null, 'info');
            showCurrentToken();
            showAllStorage();
        };
    </script>
</body>
</html>