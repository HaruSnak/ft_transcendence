services:
    chat-service:
        container_name: chat-service
        build: ./requierements/services/chat-service
        env_file: .env
        networks:
            - app_network
            - promgraf_network
            - elk_network
        restart: unless-stopped

    user-service:
        container_name: user-service
        build: ./requierements/services/user-service
        env_file: .env
        volumes:
            - user-service-data:/srcs/data
        networks:
            - app_network
            - promgraf_network
            - elk_network
        restart: unless-stopped

    nginx:
        container_name: nginx
        build:
            context: ./requierements
            dockerfile: nginx/Dockerfile
        volumes:
            - ./requierements/frontend:/usr/share/nginx/html
            - ./requierements/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
        ports:
            - "8443:443"
        depends_on:
            - chat-service
            - user-service
        networks:
            - app_network
        restart: unless-stopped

    elasticsearch:
        container_name: elasticsearch
        build: ./requierements/elk/elasticsearch
        environment:
            - discovery.type=single-node
            - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
            - ES_JAVA_OPTS=-Xms256m -Xmx256m
            - xpack.security.enabled=true
            - xpack.security.transport.ssl.enabled=false
            - xpack.security.http.ssl.enabled=false
        volumes:
            - es_data:/usr/share/elasticsearch/data
        ports:
            - "9200:9200"
        networks:
            - elk_network
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD} -f http://localhost:9200/_cluster/health || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 30
            start_period: 60s

    logstash:
        container_name: logstash
        build: ./requierements/elk/logstash
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
            - ELASTIC_USER=elastic
            - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
            - LS_JAVA_OPTS=-Xms256m -Xmx256m
            - xpack.monitoring.enabled=false
        ports:
            - "5044:5044"
            - "5000:5000"
        networks:
            - elk_network
        depends_on:
            elasticsearch:
                condition: service_healthy
        restart: unless-stopped

    kibana:
        container_name: kibana
        build: ./requierements/elk/kibana
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
            - ELASTICSEARCH_USERNAME=elastic
            - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
            - SERVER_NAME=kibana
            - SERVER_HOST=0.0.0.0
        ports:
            - "5601:5601"
        networks:
            - elk_network
        depends_on:
            elasticsearch:
                condition: service_healthy
        restart: unless-stopped

    kibana-setup:
        build: ./requierements/elk/kibana
        container_name: kibana-setup
        environment:
            - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
        networks:
            - elk_network
            - app_network
        depends_on:
            - kibana
            - user-service
            - chat-service
        command: /bin/bash /create-dashboards.sh
        restart: "no"

    prometheus:
        container_name: prometheus
        image: prom/prometheus:latest
        command:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.retention.time=30d'
        ports:
            - "9090:9090"
        volumes:
            - prometheus_db:/prometheus
            - ./requierements/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - ./requierements/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
        networks:
            - promgraf_network
        restart: unless-stopped

    node-exporter:
        container_name: node-exporter
        image: prom/node-exporter:latest
        ports:
            - "9100:9100"
        networks:
            - promgraf_network
        restart: unless-stopped

    grafana:
        container_name: grafana
        image: grafana/grafana:latest
        env_file:
            - .env
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
            - GF_SERVER_HTTP_ADDR=0.0.0.0
            - GF_SERVER_HTTP_PORT=3000
            - GF_LOG_LEVEL=warn
            - GF_ALERTING_ENABLED=false
        ports:
            - "3010:3000"
        volumes:
            - grafana_db:/var/lib/grafana
            - ./requierements/grafana/provisioning:/etc/grafana/provisioning
        networks:
            - promgraf_network
        deploy:
            resources:
                limits:
                    memory: 256M
        restart: unless-stopped

volumes:
    es_data:
    prometheus_db:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: ./volumes/prometheus_db
    grafana_db:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: ./volumes/grafana_db
    user-service-data:
        driver: local

networks:
    elk_network:
        driver: bridge
    promgraf_network:
        driver: bridge
    app_network:
        driver: bridge